<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Retailer Enrollment Sheet 2026</title>
    <style>
        /* [STYLES REMAIN EXACTLY THE SAME AS ORIGINAL] */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: linear-gradient(135deg, #ff0000 0%, #ff0000 30%, #ff0000 60%, #f8f0f0 85%, #fdfafa 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            color: #e2e8f0; 
            min-height: 100vh; 
            padding: 10px; 
            line-height: 1.5;
            font-size: 13px; 
            transition: background 0.8s ease;
        }
        
        body.tier-platinum {
            background: linear-gradient(135deg, #C9A0A0 0%, #B08585 30%, #9A7070 60%, #f5f0f0 85%, #fdfafa 100%);
        }
        
        body.tier-gold {
            background: linear-gradient(135deg, #D4A574 0%, #C49460 30%, #B5854F 60%, #f8f5f0 85%, #fdfaf8 100%);
        }
        
        body.tier-executive {
            background: linear-gradient(135deg, #E05555 0%, #D04545 30%, #C03535 60%, #f8f0f0 85%, #fdfafa 100%);
        }
        
        .container { 
            max-width: 100%;
            margin: 0 auto; 
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(250, 248, 248, 0.95)); 
            padding: 12px; 
            border-radius: 10px; 
            box-shadow: 
                0 15px 35px -12px rgb(255, 0, 0),
                0 0 0 1px rgba(200, 80, 80, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(200, 80, 80, 0.15); 
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                rgba(255, 0, 0, 0.8), 
                rgba(255, 0, 0, 0.8), 
                rgba(255, 0, 0, 0.8),
                rgba(255, 0, 0, 0.8));
            animation: shimmer 4s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.6; transform: translateX(-100%); }
            50% { opacity: 1; transform: translateX(100%); }
        }
        
        h2 { 
            text-align: center; 
            padding: 14px 12px; 
            margin: -12px -12px 14px -12px; 
            font-size: 16px; 
            font-weight: 600; 
            border-radius: 10px 10px 0 0; 
            letter-spacing: 0.3px;
            position: relative;
            box-shadow: 0 4px 16px rgba(200, 80, 80, 0.3);
            background: linear-gradient(135deg, rgba(220, 87, 87, 0.95), rgba(200, 70, 70, 0.95));
            backdrop-filter: blur(15px);
            color: #ffffff;
        }
        
        .form-section { margin-bottom: 10px; } 
        
        .form-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            margin-bottom: 8px; 
            font-size: 12px; 
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(250, 248, 248, 0.98)); 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 
                0 8px 24px rgba(200, 80, 80, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .form-table th, .form-table td { 
            border: 1px solid rgba(220, 87, 87, 0.15); 
            padding: 8px 6px; 
            text-align: center; 
            transition: all 0.3s ease; 
            color: #5a2020;
        }
        
        .form-table th { 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.9), rgba(255, 0, 0, 0.9)); 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.2px; 
            color: #ffffff;
            font-size: 10px; 
        }
        
        .form-table tr:hover { 
            background: rgba(220, 87, 87, 0.05); 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 87, 87, 0.12);
        }
        
        .left { text-align: left !important; }
        
        .highlight, .total-display, .slab-highlight, .auto-calc { 
            font-weight: 600; 
            color: #5a2020; 
            background: linear-gradient(135deg, rgba(220, 87, 87, 0.1), rgba(235, 100, 100, 0.08));
        }
        
        .section-title { 
            background: linear-gradient(135deg, rgba(220, 87, 87, 0.95), rgba(200, 70, 70, 0.95)) !important; 
            font-weight: 600; 
            text-align: center; 
            font-size: 12px; 
            text-transform: uppercase; 
            color: #ffffff !important;
            letter-spacing: 0.3px;
        }
        
        input[type="text"], input[type="number"], input[type="tel"] { 
            width: 100%; 
            height: auto; 
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(250, 248, 248, 0.95)); 
            border: 1px solid rgba(220, 87, 87, 0.25);
            color: #5a2020; 
            padding: 6px 8px; 
            border-radius: 4px; 
            font-size: 13px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
        }
        
        input:focus { 
            outline: none; 
            border-color: rgba(220, 87, 87, 0.5); 
            box-shadow: 
                0 0 0 2px rgba(220, 87, 87, 0.15),
                0 4px 12px rgba(220, 87, 87, 0.1); 
            background: linear-gradient(145deg, rgba(255, 255, 255, 1), rgba(250, 248, 248, 1)); 
            transform: translateY(-1px);
        }
        
        input[readonly] { 
            cursor: not-allowed; 
            background: linear-gradient(145deg, rgba(220, 87, 87, 0.08), rgba(235, 100, 100, 0.05)) !important; 
            color: #7a3030 !important;
        }
        
        /* Validation Styles */
        input.invalid {
            border-color: #dc3545 !important;
            background: linear-gradient(145deg, rgba(220, 53, 69, 0.1), rgba(220, 38, 38, 0.08)) !important;
            animation: shake 0.3s ease-in-out;
        }
        
        input.valid {
            border-color: #28a745 !important;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .error-message {
            color: #dc3545;
            font-size: 10px;
            margin-top: 2px;
            display: none;
            text-align: left;
        }
        
        .error-message.show {
            display: block;
        }
        
        .input-wrapper {
            position: relative;
            width: 100%;
        }
        
        .input-hint {
            font-size: 9px;
            color: rgba(90, 32, 32, 0.5);
            margin-top: 2px;
            text-align: left;
        }
        
        .required-star {
            color: #dc3545;
            margin-left: 2px;
        }
        
        .char-counter {
            font-size: 9px;
            color: rgba(90, 32, 32, 0.5);
            text-align: right;
            margin-top: 2px;
        }
        
        .char-counter.complete {
            color: #28a745;
        }
        
        .char-counter.error {
            color: #dc3545;
        }
        
        .calc-section { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(250, 248, 248, 0.98)); 
            padding: 10px; 
            border-radius: 8px; 
            margin: 10px 0; 
            box-shadow: 
                0 12px 30px rgba(200, 80, 80, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(220, 87, 87, 0.12); 
        }
        
        .total-amount { 
            text-align: center; 
            font-size: 16px; 
            font-weight: 700; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 10px 0; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(220, 87, 87, 0.2);
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(220, 87, 87, 0.95), rgba(200, 70, 70, 0.95));
            transition: all 0.5s ease;
            color: #ffffff;
        }
        
        body.tier-platinum .total-amount {
            background: linear-gradient(135deg, rgba(180, 130, 130, 0.95), rgba(155, 110, 110, 0.95));
            box-shadow: 0 10px 25px rgba(180, 130, 130, 0.3);
            color: #ffffff;
        }
        
        body.tier-gold .total-amount {
            background: linear-gradient(135deg, rgba(200, 150, 100, 0.95), rgba(180, 130, 80, 0.95));
            box-shadow: 0 10px 25px rgba(200, 150, 100, 0.3);
            color: #ffffff;
        }
        
        body.tier-executive .total-amount {
            background: linear-gradient(135deg, rgba(225, 90, 90, 0.95), rgba(210, 75, 75, 0.95));
            box-shadow: 0 10px 25px rgba(225, 90, 90, 0.3);
            color: #fff;
        }
        
        .tier-section {
            display: flex;
            justify-content: center;
            gap: 8px; 
            margin: 12px 0; 
            flex-wrap: wrap;
        }
        
        .tier-btn {
            display: flex;
            align-items: center;
            gap: 6px; 
            font-weight: 600;
            color: #5a2020;
            cursor: pointer;
            padding: 10px 14px; 
            border-radius: 8px; 
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            position: relative;
            overflow: hidden;
            flex: 1;
            min-width: 90px; 
            justify-content: center;
            border: 1px solid rgba(220, 87, 87, 0.2);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(250, 248, 248, 0.95));
            backdrop-filter: blur(15px);
            font-size: 12px;
        }
        
        .tier-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 87, 87, 0.2);
            border-color: rgba(220, 87, 87, 0.3);
        }
        
        .tier-btn input[type="radio"] { 
            width: 14px; 
            height: 14px; 
            cursor: pointer; 
            margin: 0;
        }
        
        .tier-platinum { border-color: rgba(180, 130, 130, 0.3); }
        .tier-platinum.active {
            background: linear-gradient(135deg, rgba(180, 130, 130, 0.95), rgba(155, 110, 110, 0.95));
            box-shadow: 0 10px 25px rgba(180, 130, 130, 0.4);
            transform: translateY(-3px);
            border-color: rgba(180, 130, 130, 0.6);
            color: #ffffff;
        }
        .tier-platinum input[type="radio"] { accent-color: #B48282; }
        
        .tier-gold { border-color: rgba(200, 150, 100, 0.3); }
        .tier-gold.active {
            background: linear-gradient(135deg, rgba(200, 150, 100, 0.95), rgba(180, 130, 80, 0.95));
            box-shadow: 0 10px 25px rgba(200, 150, 100, 0.4);
            transform: translateY(-3px);
            border-color: rgba(200, 150, 100, 0.6);
            color: #ffffff;
        }
        .tier-gold input[type="radio"] { accent-color: #C89664; }
        
        .tier-executive { border-color: rgba(225, 90, 90, 0.3); }
        .tier-executive.active {
            background: linear-gradient(135deg, rgba(225, 90, 90, 0.95), rgba(210, 75, 75, 0.95));
            box-shadow: 0 10px 25px rgba(225, 90, 90, 0.4);
            transform: translateY(-3px);
            border-color: rgba(225, 90, 90, 0.6);
            color: #fff;
        }
        .tier-executive input[type="radio"] { accent-color: #E15A5A; }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px; 
            margin: 14px 0 10px 0; 
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, rgba(220, 87, 87, 0.95), rgba(200, 70, 70, 0.95)); 
            color: #fff; 
            padding: 10px 16px; 
            border: none; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: hidden;
            flex: 1;
            min-width: 80px; 
            box-shadow: 0 6px 16px rgba(220, 87, 87, 0.3);
            backdrop-filter: blur(15px);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s;
        }
        
        .btn:hover::before { left: 100%; }
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 25px rgba(220, 87, 87, 0.4); 
        }
        .btn:active { transform: translateY(-1px); }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .pdf-btn { min-width: 90px; }
        
        body.tier-platinum .btn {
            background: linear-gradient(135deg, rgba(180, 130, 130, 0.95), rgba(155, 110, 110, 0.95));
            box-shadow: 0 6px 16px rgba(180, 130, 130, 0.3);
            color: #ffffff;
        }
        body.tier-platinum .btn:hover {
            box-shadow: 0 10px 25px rgba(180, 130, 130, 0.5);
        }
        
        body.tier-gold .btn {
            background: linear-gradient(135deg, rgba(200, 150, 100, 0.95), rgba(180, 130, 80, 0.95));
            box-shadow: 0 6px 16px rgba(200, 150, 100, 0.3);
            color: #ffffff;
        }
        body.tier-gold .btn:hover {
            box-shadow: 0 10px 25px rgba(200, 150, 100, 0.5);
        }
        
        body.tier-executive .btn {
            background: linear-gradient(135deg, rgba(225, 90, 90, 0.95), rgba(210, 75, 75, 0.95));
            box-shadow: 0 6px 16px rgba(225, 90, 90, 0.3);
            color: #fff;
        }
        body.tier-executive .btn:hover {
            box-shadow: 0 10px 25px rgba(225, 90, 90, 0.5);
        }
        
        .photo-section {
            margin: 10px 0;
            padding: 10px;
            background: linear-gradient(135deg, rgba(220, 87, 87, 0.08), rgba(235, 100, 100, 0.05));
            border-radius: 8px;
            border: 1px solid rgba(220, 87, 87, 0.15);
            display: none;
        }
        
        .photo-preview {
            max-width: 120px;
            max-height: 120px;
            border-radius: 6px;
            margin: 6px 0;
            border: 2px solid rgba(220, 87, 87, 0.2);
            box-shadow: 0 6px 18px rgba(220, 87, 87, 0.15);
            display: none;
        }
        
        .geo-info {
            margin-top: 6px;
            padding: 8px 10px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 248, 248, 0.95));
            border-radius: 6px;
            font-size: 11px;
            border-left: 3px solid rgba(220, 87, 87, 0.5);
            display: none;
            font-weight: 500;
            color: #5a2020;
        }
        
        .geo-info.exif-source {
            border-left-color: #28a745;
        }
        
        .geo-info.device-source {
            border-left-color: #fd7e14;
        }
        
        .geo-info.no-source {
            border-left-color: #dc3545;
        }
        
        .geo-info small {
            color: rgba(90, 32, 32, 0.7);
            font-size: 9px;
        }
        
        .geo-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            margin-left: 4px;
            text-transform: uppercase;
        }
        
        .geo-badge.exif {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .geo-badge.device {
            background: linear-gradient(135deg, #fd7e14, #e67e22);
            color: white;
        }
        
        .geo-badge.none {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .geo-badge.ip {
            background: linear-gradient(135deg, #fd7e14, #e67e22);
            color: white;
        }
        
        .ip-source {
            border-left: 3px solid #fd7e14 !important;
            background: rgba(253, 126, 20, 0.1) !important;
        }
        
        .auto-label { 
            font-size: 9px; 
            color: rgba(220, 87, 87, 0.7); 
            display: block; 
            margin-top: 3px; 
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(90, 32, 32, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #ff0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 12px;
            font-size: 13px;
            text-align: center;
        }
        
        .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            margin-top: 6px;
            font-size: 11px;
        }
        
        .debug-info {
            margin-top: 8px;
            padding: 8px;
            background: rgba(220, 87, 87, 0.1);
            border-radius: 6px;
            font-size: 10px;
            color: rgba(90, 32, 32, 0.6);
            display: none;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ff0019, #ff0019);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #fd7e14, #e67e22);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* SLAB TABLE STYLES */
        .slab-table tr {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slab-table tr.active-slab {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.25), rgba(40, 167, 69, 0.15)) !important;
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.2);
        }

        .slab-table tr.active-slab td {
            color: #28a745 !important;
            font-weight: 700 !important;
        }

        .slab-table tr.inactive-slab {
            opacity: 0.5;
        }

        .slab-table tr.next-slab {
            background: linear-gradient(135deg, rgba(253, 126, 20, 0.15), rgba(253, 126, 20, 0.08)) !important;
        }

        .slab-table tr.next-slab td:first-child::after {
            content: ' (Next)';
            font-size: 8px;
            color: #fd7e14;
            font-weight: 600;
            margin-left: 4px;
        }

        .gross-row {
            position: relative;
        }

        .gross-row.has-slab {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15), rgba(40, 167, 69, 0.08)) !important;
        }

        .gross-row.no-slab {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05)) !important;
        }

        .slab-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 4px;
            text-transform: uppercase;
            animation: pulse 2s ease-in-out infinite;
        }

        .slab-badge.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
        }

        .slab-badge.inactive {
            background: linear-gradient(135deg, #ff0019, #ff0019);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .slab-progress {
            margin-top: 4px;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 248, 248, 0.95));
            border-radius: 6px;
            font-size: 9px;
            color: #5a2020;
        }

        .progress-bar-container {
            width: 100%;
            height: 5px;
            background: rgba(220, 87, 87, 0.1);
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* Validation Summary Box */
        .validation-summary {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 38, 38, 0.08));
            border: 1px solid rgba(220, 53, 69, 0.4);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            display: none;
        }
        
        .validation-summary.show {
            display: block;
            animation: shake 0.3s ease-in-out;
        }
        
        .validation-summary h4 {
            color: #dc3545;
            margin-bottom: 6px;
            font-size: 11px;
        }
        
        .validation-summary ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .validation-summary li {
            color: #ff011a;
            font-size: 10px;
            padding: 2px 0;
        }
        
        .validation-summary li::before {
            content: '‚ö†Ô∏è ';
        }
        
        /* Table scroll wrapper for horizontal scroll */
        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }
        
        /* Touch devices - disable hover lift */
        @media (hover: none) {
            .form-table tr:hover {
                transform: none;
                box-shadow: none;
            }
            .btn:hover,
            .tier-btn:hover {
                transform: none;
            }
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">üìç Extracting GPS from photo...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait while we read location data</div>
    </div>

    <div class="container">
        <h2>Retailer Enrollment Sheet 2026</h2>
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <table class="form-table" id="basicInfoTable">
                <tr>
                    <td class="left">Outlet Name<span class="required-star">*</span></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="text" id="outletName" placeholder="Enter outlet name" data-validation="name" required>
                            <div class="input-hint">Alphabets, numbers and spaces</div>
                            <div class="error-message" id="outletName-error">Please enter a valid name</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="left">Lapu No<span class="required-star">*</span></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="tel" id="lapuNo" placeholder="10-digit LAPU number" maxlength="10" data-validation="phone" required>
                            <div class="input-hint">10 digits only</div>
                            <div class="error-message" id="lapuNo-error">Enter valid 10-digit number</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="left">FSE Contact<span class="required-star">*</span></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="tel" id="fseContact" placeholder="10-digit mobile" maxlength="10" data-validation="phone" required inputmode="numeric">
                            <div class="char-counter" id="fseContact-counter">0/10</div>
                            <div class="error-message" id="fseContact-error">Enter valid 10-digit number</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="left">TSM/SE Contact<span class="required-star">*</span></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="tel" id="tsmContact" placeholder="10-digit mobile" maxlength="10" data-validation="phone" required inputmode="numeric">
                            <div class="char-counter" id="tsmContact-counter">0/10</div>
                            <div class="error-message" id="tsmContact-error">Enter valid 10-digit number</div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <!-- Tier Selection -->
        <div class="tier-section">
            <label class="tier-btn tier-platinum">
                <input type="radio" name="tier" id="chckPlat" value="platinum">
                <span>Trident</span>
            </label>
            <label class="tier-btn tier-gold">
                <input type="radio" name="tier" id="chckGold" value="gold">
                <span>Non-Trident</span>
            </label>
            <!-- <label class="tier-btn tier-executive">
                <input type="radio" name="tier" id="chckExec" value="executive">
                <span>Executive</span>
            </label> -->
        </div>
        <!-- Validation Summary -->
        <div class="validation-summary" id="validationSummary">
            <h4>‚ö†Ô∏è Please fix the following errors:</h4>
            <ul id="validationErrors"></ul>
        </div>
        
        <!-- HIDDEN SECTIONS START (Competitor Data & Airtel Gross) -->
<div class="form-section" id="exclude-competitor">
    <div class="table-scroll">
        <table class="form-table">
            <tr class="section-title"><td colspan="4">Competitor Data</td></tr>
            <tr>
                <th>JIO MNP</th>
                <th>JIO Non-MNP</th>
                <th>VI MNP</th>
                <th>VI Non-MNP</th>

            </tr>
            <tr>
                <td><input type="number" id="viMnp" placeholder="0" min="0"></td>
                <td><input type="number" id="viDsr" placeholder="0" min="0"></td>
                <td><input type="number" id="jioMnp" placeholder="0" min="0"></td>
                <td><input type="number" id="jioDsr" placeholder="0" min="0"></td>
            </tr>
        </table>
    </div>
</div>

<div class="form-section" id="exclude-airtel">
    <div class="table-scroll">
        <table class="form-table">
            <tr>
                <th>Airtel 4G Gross</th>
                <th>Device Share</th>
            </tr>
            <tr>
                <td><input type="number" id="airtelGross" placeholder="0" min="0"></td>
                <td>
                    <input type="text" id="deviceShare" readonly placeholder="Auto calculated" style="color: #28a745; font-weight: 600;"%>
                    <span class="auto-label">Auto Calculated</span>
                </td>
            </tr>
        </table>
    </div>
</div>
        <!-- HIDDEN SECTIONS END -->

            <!-- Margin Calculations -->
        <div class="form-section">
            <table class="form-table">
                <tr class="section-title"><td colspan="3">Margin Calculations</td></tr>
                <tr><td class="left">Lapu Tertiary</td><td><input type="number" id="lapuTertiary" placeholder="0" min="0"></td><td><input type="text" id="tertiaryAmount" readonly class="total-display"></td></tr>
                <tr><td class="left">MNP Days</td><td><input type="number" id="mnpDays" placeholder="0" min="0"></td><td><input type="text" id="mnpDaysAmount" readonly class="total-display"></td></tr>
                <tr><td class="left">WiFi Days</td><td><input type="number" id="wifiDays" placeholder="0" min="0"></td><td><input type="text" id="wifiDaysAmount" readonly class="total-display"></td></tr>
            </table>
        </div>

        <!-- Additional Items -->
        <table class="form-table">
            <tr><td class="left">WIFI</td><td><input type="number" id="wifiCount" placeholder="0" min="0"></td><td><input type="text" id="wifiAmount" readonly class="total-display"></td></tr>
            <tr><td class="left">APB SBA</td><td><input type="number" id="apbCount" placeholder="0" min="0"></td><td><input type="text" id="apbAmount" readonly class="total-display"></td></tr>
            <tr><td class="left">SIM SWAP</td><td><input type="number" id="simexCount" placeholder="0" min="0"></td><td><input type="text" id="simexAmount" readonly class="total-display"></td></tr>
        </table>

        <!-- Margin Scheme -->
        <div class="form-section">
            <table class="form-table">
            <tr class="section-title"><td colspan="3">RECHARGE COMMISSION</td></tr>

                <tr><th>Scheme</th><th>Margin</th><th>Gate</th></tr>
                <tr><td class="left">Base Margins</td><td>3%</td><td>-</td></tr>
                <tr><td class="left">MNP Participation</td><td>1.40%</td><td>1 MNP/Day</td></tr>
                <tr><td class="left">WIFI Participation</td><td>1.50%</td><td>1 WIFI/Day</td></tr>
                <tr class="highlight"><td class="left">Total Margin</td><td>6.80%</td><td>-</td></tr>
            </table>
        </div>

        <!-- OTF Section -->
        <div class="form-section">
            <table class="form-table">
                <tr class="section-title"><td colspan="3">NEW CUSTOMER AQUICISITION</td></tr>
                <tr><th>FRC</th><th>Non-MNP</th><th>MNP</th></tr>
                <tr><td>349</td><td>135</td><td>235</td></tr>
                <tr><td colspan="3" style="text-align: center; font-weight: 600;">SIM SWAP ‚Äì Rs.50 Per SIM SWAP</td></tr>
            </table>
        </div>

        <!-- Main Calculation Section -->
        <div class="calc-section">
            <table class="form-table">
                <tr class="section-title"><td colspan="3">COMMITMENT & COMMISSION</td></tr>

                <tr><th>Items</th><th>Count</th><th>Amount</th></tr>
                <tr><td class="left"><span id="dsrLabel">Non MNP OTF - Rs.135</span></td><td><input type="number" id="dsrCount" placeholder="0" min="0"></td><td><input type="text" id="dsrAmount" readonly class="total-display"></td></tr>
                <tr><td class="left">MNP OTF - Rs.235</td><td><input type="number" id="mnpCount" placeholder="0" min="0"></td><td><input type="text" id="mnpAmount" readonly class="total-display"></td></tr>
                <tr class="gross-row slab-highlight" id="grossRow">
                    <td class="left">GROSS COMMITMENT & COMMISSION(DTR-Slab Incentive)</td>
                    <td><input type="text" id="grossCount" readonly class="auto-calc"></td>
                    <td><input type="text" id="grossAmount" readonly class="total-display slab-highlight"></td>
                </tr>
                <tr>
                    <td class="left" colspan='3'>
                        <span id="slabBadge" class="slab-badge inactive">No Slab</span>
                        <br>
                        <span class="auto-label" id="slabLabel">Slab Rate √ó MNP Count</span>
                        <div class="slab-progress" id="slabProgress" style="display: none;">
                            <span id="progressText"></span>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="total-amount" id="totalAmount">Total Amount Rs. 0</div>

        
        <!-- HIDDEN SECTIONS START (Targets & Slab Table) -->
        <!-- These are kept in code but hidden with CSS so JS variables don't crash -->
        <div class="form-section" id="exclude-targets" style="display:none;">
            <div class="table-scroll">
                <table class="form-table">
                    <tr><th>DSR TGT</th><th>MNP TGT</th><th>TOTAL TGT</th><th>WIFI TGT</th></tr>
                    <tr>
                        <td><input type="number" id="dsrTarget" placeholder="0" min="0" value="0"></td>
                        <td><input type="number" id="mnpTarget" placeholder="0" min="0" value="0"></td>
                        <td><input type="number" id="totalTarget" readonly value="0"></td>
                        <td><input type="number" id="wifiTarget" placeholder="0" min="0" value="0"></td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="form-section" style="display:none;">
            <table class="form-table slab-table" id="slabTable">
                <tr><th>Gross Target SLAB</th><th>INCENTIVE (PER MNP)</th></tr>
                <tr id="slab-10"><td>10</td><td>‚Çπ75/MNP</td></tr>
                <tr id="slab-20"><td>20</td><td>‚Çπ125/MNP</td></tr>
                <tr id="slab-30"><td>30</td><td>‚Çπ150/MNP</td></tr>
                <tr id="slab-50"><td>40+</td><td>‚Çπ200/MNP</td></tr>
            </table>
        </div>
        <!-- HIDDEN SECTIONS END -->


        <!-- Photo & Geo Section -->
        <div class="photo-section" id="photoSection">
            <img id="photoPreview" class="photo-preview" alt="Captured Photo">
            <div id="geoInfo" class="geo-info"></div>
            <div id="debugInfo" class="debug-info"></div>
        </div>
        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">
        <input type="hidden" id="locAccuracy">
        <span id="locationStatus" style="display:none;"></span>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="pdfBtn" class="btn photo-btn">Download & Share PDF</button>
            <button id="captureBtn" disabled class="btn photo-btn">Capture Photo</button>
            <button id="submitBtn" disabled class="btn photo-btn">Submit Data</button>
            
        </div>
    </div>

<script>
    // =============================================
    //  CONFIGURATION & GLOBALS
    // =============================================
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5asUedKfwV3b6fQ0d1jq7REHOo1HGvsuyb-zZP_KFQ38dMSPSi9IxbirDPumYb6ZCsA/exec';
    
    let capturedPhoto = null;
    let geoLocation = null;
    let geoSource = null;
    let geoAccuracy = null;
    let photoTimestamp = null;
    let selectedTier = null;
    let originalFile = null;

    function checkReadyForSubmit() {
        document.getElementById('submitBtn').disabled = !(
            capturedPhoto && geoLocation
        );
    }

    // =============================================
    // VALIDATION RULES
    // =============================================
    const validationRules = {
        name: {
            pattern: /^[A-Za-z0-9\s]+$/,
            message: 'Only alphabets, numbers and spaces allowed',
            minLength: 2,
            maxLength: 100
        },
        phone: {
            pattern: /^[6-9][0-9]{9}$/,
            message: 'Enter valid 10-digit mobile number (starting with 6-9)',
            exactLength: 10
        },
        alphanumeric: {
            pattern: /^[A-Za-z0-9\s\-]+$/,
            message: 'Only alphanumeric characters allowed',
            minLength: 1
        }
    };

    // =============================================
    // VALIDATION FUNCTIONS
    // =============================================
    function validateField(input) {
        const validationType = input.dataset.validation;
        const value = input.value.trim();
        const errorElement = document.ById(`${input.id}-error`);
        
        let isValid = true;
        let errorMessage = '';

        if (!value && input.hasAttribute('required')) {
            isValid = false;
            errorMessage = 'This field is required';
        } else if (value && validationType && validationRules[validationType]) {
            const rule = validationRules[validationType];
            
            if (rule.pattern && !rule.pattern.test(value)) {
                isValid = false;
                errorMessage = rule.message;
            }
            
            if (rule.exactLength && value.length !== rule.exactLength) {
                isValid = false;
                errorMessage = `Must be exactly ${rule.exactLength} digits`;
            }
            
            if (rule.minLength && value.length < rule.minLength) {
                isValid = false;
                errorMessage = `Minimum ${rule.minLength} characters required`;
            }
        }

        input.classList.remove('valid', 'invalid');
        if (value) {
            input.classList.add(isValid ? 'valid' : 'invalid');
        }
        
        if (errorElement) {
            errorElement.textContent = errorMessage;
            errorElement.classList.toggle('show', !isValid && (value || input.hasAttribute('required')));
        }

        return isValid;
    }

    function validateAllFields() {
        const requiredFields = [
            { id: 'outletName', label: 'Outlet Name' },
            { id: 'lapuNo', label: 'Outlet Lapu No' },
            { id: 'fseContact', label: 'FSE Contact No' },
            { id: 'tsmContact', label: 'TSM/SE Contact No' }
        ];

        const errors = [];
        let allValid = true;

        requiredFields.forEach(field => {
            const input = document.ById(field.id);
            if (input) {
                const value = input.value.trim();
                const isValid = validateField(input);
                
                if (!isValid) {
                    allValid = false;
                    if (!value) {
                        errors.push(`${field.label} is required`);
                    } else {
                        const validationType = input.dataset.validation;
                        if (validationType && validationRules[validationType]) {
                            errors.push(`${field.label}: ${validationRules[validationType].message}`);
                        }
                    }
                }
            }
        });

        const summary = document.getElementById('validationSummary');
        const errorList = document.getElementById('validationErrors');
        
        if (errors.length > 0) {
            errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
            summary.classList.add('show');
        } else {
            summary.classList.remove('show');
        }

        return allValid;
    }

    // =============================================
    // INPUT RESTRICTION FUNCTIONS
    // =============================================
    function restrictToAlphabets(input) {
        input.addEventListener('input', function(e) {
            const cursorPos = this.selectionStart;
            const oldValue = this.value;
            this.value = this.value.replace(/[^A-Za-z0-9\s]/g, '');
            
            if (oldValue.length !== this.value.length) {
                const diff = oldValue.length - this.value.length;
                this.setSelectionRange(cursorPos - diff, cursorPos - diff);
            }
        });
        
        input.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.keyCode || e.which);
            if (!/[A-Za-z0-9\s]/.test(char)) {
                e.preventDefault();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const cleanedText = pastedText.replace(/[^A-Za-z0-9\s]/g, '');
            document.execCommand('insertText', false, cleanedText);
        });
    }

    function restrictToNumbers(input) {
        const counterId = `${input.id}-counter`;
        const counterElement = document.getElementById(counterId);
        
        function updateCounter() {
            const length = input.value.length;
            if (counterElement) {
                counterElement.textContent = `${length}/10 digits`;
                counterElement.classList.remove('complete', 'error');
                if (length === 10) {
                    counterElement.classList.add('complete');
                } else if (length > 0 && length < 10) {
                    counterElement.classList.add('error');
                }
            }
        }
        
        input.addEventListener('input', function(e) {
            const cursorPos = this.selectionStart;
            const oldValue = this.value;
            this.value = this.value.replace(/[^0-9]/g, '');
            
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
            
            updateCounter();
            
            if (this.value.length === 10) {
                validateField(this);
            }
        });
        
        input.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.keyCode || e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
                return;
            }
            if (this.value.length >= 10) {
                e.preventDefault();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const cleanedText = pastedText.replace(/[^0-9]/g, '').slice(0, 10 - this.value.length);
            
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const currentValue = this.value;
            const newValue = currentValue.slice(0, start) + cleanedText + currentValue.slice(end);
            this.value = newValue.slice(0, 10);
            
            updateCounter();
        });
        
        updateCounter();
    }

    function restrictToAlphanumeric(input) {
        input.addEventListener('input', function(e) {
            const cursorPos = this.selectionStart;
            const oldValue = this.value;
            this.value = this.value.replace(/[^A-Za-z0-9\s\-]/g, '');
        });
        
        input.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.keyCode || e.which);
            if (!/[A-Za-z0-9\s\-]/.test(char)) {
                e.preventDefault();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const cleanedText = pastedText.replace(/[^A-Za-z0-9\s\-]/g, '');
            document.execCommand('insertText', false, cleanedText);
        });
    }

    // =============================================
    // INITIALIZE VALIDATIONS
    // =============================================
    function initializeValidations() {
        const outletName = document.getElementById('outletName');
        if (outletName) {
            restrictToAlphabets(outletName);
            outletName.addEventListener('blur', () => validateField(outletName));
            outletName.addEventListener('input', () => {
                if (outletName.classList.contains('invalid')) {
                    validateField(outletName);
                }
            });
        }

        const fseContact = document.getElementById('fseContact');
        if (fseContact) {
            restrictToNumbers(fseContact);
            fseContact.addEventListener('blur', () => validateField(fseContact));
            fseContact.addEventListener('input', () => {
                if (fseContact.classList.contains('invalid') || fseContact.value.length === 10) {
                    validateField(fseContact);
                }
            });
        }

        const tsmContact = document.getElementById('tsmContact');
        if (tsmContact) {
            restrictToNumbers(tsmContact);
            tsmContact.addEventListener('blur', () => validateField(tsmContact));
            tsmContact.addEventListener('input', () => {
                if (tsmContact.classList.contains('invalid') || tsmContact.value.length === 10) {
                    validateField(tsmContact);
                }
            });
        }

        const lapuNo = document.getElementById('lapuNo');
        if (lapuNo) {
            restrictToNumbers(lapuNo);
            lapuNo.addEventListener('blur', () => validateField(lapuNo));
            lapuNo.addEventListener('input', () => {
                if (lapuNo.classList.contains('invalid') || lapuNo.value.length === 10) {
                    validateField(lapuNo);
                }
            });
        }
    }

    // =============================================
    // TOAST NOTIFICATION
    // =============================================
    function showToast(message, type = 'info', duration = 5000) {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), duration);
    }

    // =============================================
    // DEVICE DETECTION
    // =============================================
    function getDeviceInfo() {
        const ua = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
        const isAndroid = /Android/.test(ua);
        const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/CriOS/.test(ua);
        const isChrome = /Chrome/.test(ua) || /CriOS/.test(ua);
        const isIOSChrome = /CriOS/.test(ua);
        const isIOSSafari = isIOS && isSafari;
        
        let iOSVersion = 0;
        if (isIOS) {
            const match = ua.match(/OS (\d+)_/);
            if (match) {
                iOSVersion = parseInt(match[1], 10);
            }
        }
        
        const isSecure = window.isSecureContext || 
                         window.location.protocol === 'https:' || 
                         window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1';
        
        return {
            isIOS,
            isAndroid,
            isSafari,
            isChrome,
            isIOSChrome,
            isIOSSafari,
            iOSVersion,
            isMobile: isIOS || isAndroid,
            userAgent: ua,
            isSecureContext: isSecure,
            protocol: window.location.protocol,
            hostname: window.location.hostname,
            supportsGeolocation: 'geolocation' in navigator
        };
    }

    // =============================================
    // PRECISE LOCATION METHOD (Returns Promise)
    // =============================================
    function getPreciseLocationPromise() {
        return new Promise((resolve, reject) => {
            const latInput = document.getElementById('latitude');
            const lonInput = document.getElementById('longitude');
            const accInput = document.getElementById('locAccuracy');

            if (!navigator.geolocation) {
                reject(new Error('Geolocation not supported'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = position.coords;
                    const latitude = coords.latitude.toFixed(6);
                    const longitude = coords.longitude.toFixed(6);
                    const accuracy = coords.accuracy.toFixed(0);

                    if (latInput) latInput.value = latitude;
                    if (lonInput) lonInput.value = longitude;
                    if (accInput) accInput.value = accuracy;

                    geoLocation = `${latitude}, ${longitude}`;
                    geoSource = 'Device GPS';
                    geoAccuracy = `${accuracy}m`;

                    resolve({
                        latitude: latitude,
                        longitude: longitude,
                        accuracy: accuracy + 'm',
                        method: 'Device GPS'
                    });
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        });
    }

    // =============================================
    // DISPLAY GPS INFO
    // =============================================
    function displayGPSInfo(gpsData, source) {
        const geoInfo = document.getElementById('geoInfo');
        const photoSection = document.getElementById('photoSection');
        
        if (!geoInfo) return;
        
        geoInfo.classList.remove('exif-source', 'device-source', 'no-source', 'ip-source');
        
        if (source === 'exif' && gpsData) {
            geoLocation = `${gpsData.latitude}, ${gpsData.longitude}`;
            geoSource = 'EXIF';
            geoAccuracy = null;
            geoInfo.classList.add('exif-source');
            
            geoInfo.innerHTML = `
                <strong>üìç GPS from Photo:</strong> 
                <span class="geo-badge exif">PHOTO EXIF ‚úì</span><br><br>
                <strong>Coordinates:</strong> ${geoLocation}<br>
                ${gpsData.altitude ? `<strong>Altitude:</strong> ${gpsData.altitude}<br>` : ''}
                ${gpsData.timestamp ? `<strong>Photo Time:</strong> ${gpsData.timestamp}<br>` : ''}
                <small>Location extracted directly from photo metadata (${gpsData.method})</small>
            `;
            
        } else if (source === 'device' && gpsData) {
            geoLocation = `${gpsData.latitude}, ${gpsData.longitude}`;
            geoSource = gpsData.method || 'Device GPS';
            geoAccuracy = gpsData.accuracy || null;
            
            geoInfo.classList.add('device-source');
            
            geoInfo.innerHTML = `
                <strong>üõ∞Ô∏è GPS Location Captured:</strong>
                <span class="geo-badge device">GPS LOCKED ‚úì</span><br><br>
                <strong>Coordinates:</strong> ${geoLocation}<br>
                <strong>Accuracy:</strong> ¬±${gpsData.accuracy}<br>
                <strong>Time:</strong> ${new Date().toLocaleString('en-IN')}<br>
                <small>Precise location captured successfully</small>
            `;
            
        } else {
            geoLocation = null;
            geoSource = null;
            geoAccuracy = null;
            geoInfo.classList.add('no-source');
            
            geoInfo.innerHTML = `
                <strong>üìç Location:</strong>
                <span class="geo-badge none">NOT CAPTURED</span><br><br>
                <small> Location not captured.<br>
                <strong>Please ensure location permission is enabled.</strong></small>
            `;
        }
        
        geoInfo.style.display = 'block';
        if (photoSection) {
            photoSection.style.display = 'block';
        }
    }

    // =============================================
    // EXIF EXTRACTION FUNCTIONS
    // =============================================
    function extractGPSFromImage(file) {
        return new Promise((resolve) => {
            const device = getDeviceInfo();
            console.log('Device:', device);
            
            if (device.isIOS) {
                console.log('iOS detected - skipping EXIF extraction');
                resolve(null);
                return;
            }
            
            if (typeof EXIF !== 'undefined') {
                extractWithEXIFJS(file).then(result => {
                    if (result) {
                        resolve(result);
                    } else {
                        extractManually(file).then(manualResult => {
                            resolve(manualResult);
                        });
                    }
                }).catch(() => {
                    extractManually(file).then(manualResult => {
                        resolve(manualResult);
                    });
                });
            } else {
                extractManually(file).then(result => {
                    resolve(result);
                });
            }
        });
    }

    function extractWithEXIFJS(file) {
        return new Promise((resolve) => {
            try {
                const img = document.createElement('img');
                const objectUrl = URL.createObjectURL(file);
                
                img.onload = function() {
                    try {
                        EXIF.getData(img, function() {
                            try {
                                const lat = EXIF.getTag(this, 'GPSLatitude');
                                const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                                const lon = EXIF.getTag(this, 'GPSLongitude');
                                const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
                                const altitude = EXIF.getTag(this, 'GPSAltitude');
                                const dateTime = EXIF.getTag(this, 'DateTimeOriginal') || EXIF.getTag(this, 'DateTime');
                                
                                if (lat && lon && latRef && lonRef) {
                                    const latitude = convertToDecimal(lat, latRef);
                                    const longitude = convertToDecimal(lon, lonRef);
                                    
                                    URL.revokeObjectURL(objectUrl);
                                    resolve({
                                        latitude: latitude.toFixed(6),
                                        longitude: longitude.toFixed(6),
                                        altitude: altitude ? (altitude.numerator / altitude.denominator).toFixed(1) + 'm' : null,
                                        timestamp: dateTime || null,
                                        method: 'EXIF.js'
                                    });
                                } else {
                                    URL.revokeObjectURL(objectUrl);
                                    resolve(null);
                                }
                            } catch (e) {
                                URL.revokeObjectURL(objectUrl);
                                resolve(null);
                            }
                        });
                    } catch (e) {
                        URL.revokeObjectURL(objectUrl);
                        resolve(null);
                    }
                };
                
                img.onerror = function() {
                    URL.revokeObjectURL(objectUrl);
                    resolve(null);
                };
                
                img.src = objectUrl;
                
                setTimeout(() => {
                    URL.revokeObjectURL(objectUrl);
                }, 10000);
                
            } catch (e) {
                resolve(null);
            }
        });
    }

    function convertToDecimal(dmsArray, ref) {
        if (!dmsArray || dmsArray.length < 3) return 0;
        
        let degrees, minutes, seconds;
        
        if (typeof dmsArray[0] === 'object' && dmsArray[0].numerator !== undefined) {
            degrees = dmsArray[0].numerator / dmsArray[0].denominator;
            minutes = dmsArray[1].numerator / dmsArray[1].denominator;
            seconds = dmsArray[2].numerator / dmsArray[2].denominator;
        } else {
            degrees = parseFloat(dmsArray[0]) || 0;
            minutes = parseFloat(dmsArray[1]) || 0;
            seconds = parseFloat(dmsArray[2]) || 0;
        }
        
        let decimal = degrees + (minutes / 60) + (seconds / 3600);
        
        if (ref === 'S' || ref === 'W') {
            decimal = -decimal;
        }
        
        return decimal;
    }

    function extractManually(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const buffer = e.target.result;
                    const view = new DataView(buffer);
                    
                    if (view.getUint16(0, false) !== 0xFFD8) {
                        resolve(null);
                        return;
                    }
                    
                    let offset = 2;
                    const length = Math.min(view.byteLength, 65536);
                    
                    while (offset < length) {
                        if (view.getUint8(offset) !== 0xFF) {
                            offset++;
                            continue;
                        }
                        
                        const marker = view.getUint8(offset + 1);
                        
                        if (marker === 0xE1) {
                            const exifData = parseEXIFSegment(view, offset + 4);
                            if (exifData) {
                                resolve({
                                    ...exifData,
                                    method: 'Manual'
                                });
                                return;
                            }
                        }
                        
                        if (marker === 0xD9 || marker === 0xDA) break;
                        
                        const segmentLength = view.getUint16(offset + 2, false);
                        offset += 2 + segmentLength;
                    }
                    
                    resolve(null);
                } catch (e) {
                    resolve(null);
                }
            };
            
            reader.onerror = () => resolve(null);
            reader.readAsArrayBuffer(file);
        });
    }

    function parseEXIFSegment(view, start) {
        try {
            if (view.getUint32(start, false) !== 0x45786966) return null;
            
            const tiffOffset = start + 6;
            const littleEndian = view.getUint16(tiffOffset, false) === 0x4949;
            
            const ifd0Offset = view.getUint32(tiffOffset + 4, littleEndian) + tiffOffset;
            
            const gpsIFDPointer = findTagValue(view, ifd0Offset, 0x8825, littleEndian, tiffOffset);
            if (!gpsIFDPointer) return null;
            
            const gpsOffset = gpsIFDPointer + tiffOffset;
            return parseGPSData(view, gpsOffset, littleEndian, tiffOffset);
        } catch (e) {
            return null;
        }
    }

    function findTagValue(view, ifdOffset, tagId, littleEndian, tiffOffset) {
        try {
            const entries = view.getUint16(ifdOffset, littleEndian);
            
            for (let i = 0; i < entries; i++) {
                const entryOffset = ifdOffset + 2 + (i * 12);
                const tag = view.getUint16(entryOffset, littleEndian);
                
                if (tag === tagId) {
                    return view.getUint32(entryOffset + 8, littleEndian);
                }
            }
        } catch (e) {}
        return null;
    }

    function parseGPSData(view, gpsOffset, littleEndian, tiffOffset) {
        try {
            const entries = view.getUint16(gpsOffset, littleEndian);
            
            let lat = null, latRef = null, lon = null, lonRef = null, alt = null;
            
            for (let i = 0; i < entries; i++) {
                const entryOffset = gpsOffset + 2 + (i * 12);
                const tag = view.getUint16(entryOffset, littleEndian);
                const valueOffset = view.getUint32(entryOffset + 8, littleEndian);
                
                switch (tag) {
                    case 0x0001:
                        latRef = String.fromCharCode(view.getUint8(entryOffset + 8));
                        break;
                    case 0x0002:
                        lat = readRational3(view, valueOffset + tiffOffset, littleEndian);
                        break;
                    case 0x0003:
                        lonRef = String.fromCharCode(view.getUint8(entryOffset + 8));
                        break;
                    case 0x0004:
                        lon = readRational3(view, valueOffset + tiffOffset, littleEndian);
                        break;
                    case 0x0006:
                        const num = view.getUint32(valueOffset + tiffOffset, littleEndian);
                        const den = view.getUint32(valueOffset + tiffOffset + 4, littleEndian);
                        alt = (num / den).toFixed(1);
                        break;
                }
            }
            
            if (lat && lon && latRef && lonRef) {
                const latitude = dmsToDecimal(lat, latRef);
                const longitude = dmsToDecimal(lon, lonRef);
                
                return {
                    latitude: latitude.toFixed(6),
                    longitude: longitude.toFixed(6),
                    altitude: alt ? alt + 'm' : null
                };
            }
        } catch (e) {}
        return null;
    }

    function readRational3(view, offset, littleEndian) {
        const values = [];
        for (let i = 0; i < 3; i++) {
            const num = view.getUint32(offset + (i * 8), littleEndian);
            const den = view.getUint32(offset + (i * 8) + 4, littleEndian);
            values.push(num / den);
        }
        return values;
    }

    function dmsToDecimal(dms, ref) {
        let dd = dms[0] + dms[1] / 60 + dms[2] / 3600;
        if (ref === 'S' || ref === 'W') dd = -dd;
        return dd;
    }

    // =============================================
    // DEVICE SHARE CALCULATION
    // =============================================
function calculateDeviceShare() {
    const airtelGross = parseFloat(document.getElementById('airtelGross').value) || 0;
    const jioMnp = parseFloat(document.getElementById('jioMnp').value) || 0;
    const jioDsr = parseFloat(document.getElementById('jioDsr').value) || 0;

    const jioTotal = jioMnp + jioDsr;
    const deviceShareInput = document.getElementById('deviceShare');

    if (jioTotal === 0) {
        if (airtelGross > 0) {
            deviceShareInput.value = '‚àû (No JIO)';
            deviceShareInput.style.setProperty('color', '#28a745', 'important');
        } else {
            deviceShareInput.value = '';
            deviceShareInput.style.setProperty('color', '#888', 'important');
        }
        return;
    }

    const deviceSharePercent = (airtelGross / jioTotal) * 100;
    deviceShareInput.value = deviceSharePercent.toFixed(2) + '%';

    if (deviceSharePercent < 100.00) {
        deviceShareInput.style.setProperty('color', '#dc3545', 'important');
    } else {
        deviceShareInput.style.setProperty('color', '#28a745', 'important');
    }
}

    // =============================================
    // ENHANCED SLAB RATE FUNCTIONS
    // =============================================
    
const SLAB_THRESHOLDS = [
        { min: 40, rate: 200, label: '40+', id: 'slab-40' },
        { min: 30, rate: 150, label: '30', id: 'slab-30' },
        { min: 20, rate: 125, label: '20', id: 'slab-20' },
        { min: 10, rate: 75, label: '10', id: 'slab-10' },
    ];

    function getSlabRate(grossCount) {
        if (grossCount >= 40) return 200;
        if (grossCount >= 30) return 150;
        if (grossCount >= 20) return 125;
        if (grossCount >= 10) return 75;
        return 0;
    }

    function getSlabInfo(grossCount) {
        for (let i = 0; i < SLAB_THRESHOLDS.length; i++) {
            if (grossCount >= SLAB_THRESHOLDS[i].min) {
                const nextSlab = i > 0 ? SLAB_THRESHOLDS[i - 1] : null;
                return {
                    rate: SLAB_THRESHOLDS[i].rate,
                    label: SLAB_THRESHOLDS[i].label,
                    id: SLAB_THRESHOLDS[i].id,
                    index: SLAB_THRESHOLDS.length - 1 - i,
                    nextSlab: nextSlab,
                    neededForNext: nextSlab ? nextSlab.min - grossCount : 0,
                    isMaxSlab: i === 0
                };
            }
        }
        
        return {
            rate: 0,
            label: 'Below 10',
            id: null,
            index: -1,
            nextSlab: SLAB_THRESHOLDS[SLAB_THRESHOLDS.length - 1],
            neededForNext: 10 - grossCount,
            isMaxSlab: false
        };
    }

    function highlightActiveSlab(slabInfo) {
        const slabTable = document.getElementById('slabTable');
        if (!slabTable) return;
        
        const rows = slabTable.querySelectorAll('tr');
        rows.forEach(row => {
            row.classList.remove('active-slab', 'inactive-slab', 'next-slab');
        });
        
        SLAB_THRESHOLDS.forEach((slab, index) => {
            const row = document.getElementById(slab.id);
            if (!row) return;
            
            if (slab.id === slabInfo.id) {
                row.classList.add('active-slab');
            } else if (slabInfo.nextSlab && slab.id === slabInfo.nextSlab.id) {
                row.classList.add('next-slab');
            } else if (slab.rate > slabInfo.rate) {
                row.classList.add('inactive-slab');
            }
        });
    }
function updateGrossRowStyling(slabInfo, mnpCount) {
    const grossRow = document.getElementById('grossRow');
    const slabBadge = document.getElementById('slabBadge');
    const slabLabel = document.getElementById('slabLabel');
    const slabProgress = document.getElementById('slabProgress');
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    
    if (slabInfo.rate > 0) {
        grossRow.classList.add('has-slab');
        grossRow.classList.remove('no-slab');
        slabBadge.classList.add('active');
        slabBadge.classList.remove('inactive');
        slabBadge.textContent = `‚Çπ${slabInfo.rate}/MNP`;
    } else {
        grossRow.classList.remove('has-slab');
        grossRow.classList.add('no-slab');
        slabBadge.classList.remove('active');
        slabBadge.classList.add('inactive');
        slabBadge.textContent = 'No Slab';
    }
    
    if (slabInfo.rate > 0) {
        slabLabel.innerHTML = `
            <strong>Slab ${slabInfo.label}</strong> ‚Üí ‚Çπ${slabInfo.rate} √ó ${mnpCount} MNP = 
            <strong style="color: #28a745;">‚Çπ${(slabInfo.rate * mnpCount).toLocaleString('en-IN')}</strong>
        `;
    } else {
        slabLabel.textContent = 'Need minimum 10 Gross to unlock slab incentive';
    }
    
    if (!slabInfo.isMaxSlab && slabInfo.nextSlab) {
        slabProgress.style.display = 'block';
        progressText.innerHTML = `<span style="color: #fd7e14;">üéØ ${slabInfo.neededForNext} more for ‚Çπ${slabInfo.nextSlab.rate}/MNP slab</span>`;
        
        let progressPercent = 0;
        if (slabInfo.rate === 0) {
            progressPercent = (10 - slabInfo.neededForNext) / 10 * 100;
        } else {
            const currentMin = SLAB_THRESHOLDS.find(s => s.rate === slabInfo.rate).min;
            const nextMin = slabInfo.nextSlab.min;
            const range = nextMin - currentMin;
            const current = nextMin - slabInfo.neededForNext - currentMin;
            progressPercent = (current / range) * 100;
        }
        progressBar.style.width = `${Math.max(0, Math.min(100, progressPercent))}%`;
    } else if (slabInfo.isMaxSlab) {
        slabProgress.style.display = 'block';
        progressText.innerHTML = `<span style="color: #28a745;">üèÜ Maximum slab achieved!</span>`;
        progressBar.style.width = '100%';
    } else {
        slabProgress.style.display = 'none';
    }
}

    // =============================================
    // MAIN CALCULATION FUNCTION
    // =============================================
    function calculateAll() {
    const dsrCount = parseInt(document.getElementById('dsrCount').value) || 0;
    const mnpCount = parseInt(document.getElementById('mnpCount').value) || 0;
    const wifiCount = parseInt(document.getElementById('wifiCount').value) || 0;
    const apbCount = parseInt(document.getElementById('apbCount').value) || 0;
    const simexCount = parseInt(document.getElementById('simexCount').value) || 0;
    const lapuTertiary = parseInt(document.getElementById('lapuTertiary').value) || 0;
    const mnpDays = parseInt(document.getElementById('mnpDays').value) || 0;
    const wifiDays = parseInt(document.getElementById('wifiDays').value) || 0;

    // Calculate DSR OTF with Platinum bonus (Rs.25 extra per DSR for Platinum tier)
    const platinumDsrBonus = (selectedTier === 'platinum') ? 25 : 0;
    const dsrRate = 135 + platinumDsrBonus;
    const dsrAmount = dsrCount * dsrRate;
    document.getElementById('dsrAmount').value = dsrAmount.toLocaleString('en-IN');
    
    // Update DSR label to show the rate dynamically
    const dsrLabel = document.getElementById('dsrLabel');
    if (dsrLabel) {
        if (selectedTier === 'platinum') {
            dsrLabel.innerHTML = 'Non MNP OTF - Rs.135 <span style="color: #B48282; font-weight: bold;">+ Rs.25</span>';
        } else {
            dsrLabel.textContent = 'Non MNP - Rs.135';
        }
    }
    
    // MNP OTF (no change)
    const mnpAmount = mnpCount * 235;
    document.getElementById('mnpAmount').value = mnpAmount.toLocaleString('en-IN');

    // Gross Commitment (Slab based on Gross Count)
    const grossCount = dsrCount + mnpCount;
    const slabInfo = getSlabInfo(grossCount);
    const slabRate = slabInfo.rate;
    const grossCommitmentAmount = mnpCount * slabRate;
    
    document.getElementById('grossCount').value = grossCount;
    document.getElementById('grossAmount').value = grossCommitmentAmount.toLocaleString('en-IN');
    
    highlightActiveSlab(slabInfo);
    updateGrossRowStyling(slabInfo, mnpCount);

    // Margin Calculations
    const tertiaryAmount = lapuTertiary * 0.003;
    const mnpDaysAmount = (lapuTertiary / 30 * 0.014) * mnpDays;
    const wifiDaysAmount = (lapuTertiary / 30 * 0.015) * wifiDays;
    document.getElementById('tertiaryAmount').value = tertiaryAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 });
    document.getElementById('mnpDaysAmount').value = mnpDaysAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 });
    document.getElementById('wifiDaysAmount').value = wifiDaysAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 });

    // Additional Items
    const wifiAmount = wifiCount * 150;
    const apbAmount = apbCount * 45;
    const simexAmount = simexCount * 50;
    document.getElementById('wifiAmount').value = wifiAmount.toLocaleString('en-IN');
    document.getElementById('apbAmount').value = apbAmount.toLocaleString('en-IN');
    document.getElementById('simexAmount').value = simexAmount.toLocaleString('en-IN');

    // Total Calculation
    const total = dsrAmount +
                 mnpAmount +
                 grossCommitmentAmount + 
                 wifiAmount + 
                 apbAmount + 
                 simexAmount + 
                 tertiaryAmount + 
                 mnpDaysAmount + 
                 wifiDaysAmount;
    
    document.getElementById('totalAmount').textContent = `Total Amount Rs. ${Math.round(total).toLocaleString('en-IN')}`;
}

    // =============================================
    // CAMERA CAPTURE HANDLER (iOS COMPATIBLE)
    // =============================================
    async function handleCameraCapture() {
        const device = getDeviceInfo();
        const loading = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtext = document.getElementById('loadingSubtext');
        
        // ========== iOS FIX: Open camera FIRST (synchronously) ==========
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        
        if (device.isIOS) {
            input.setAttribute('capture', 'camera');
        } else if (device.isMobile) {
            input.setAttribute('capture', 'environment');
        }
        
        input.style.cssText = 'position:fixed;top:0;left:0;opacity:0;pointer-events:none;';
        document.body.appendChild(input);
        
        // Handle file selection
        input.onchange = async function() {
            if (!this.files || !this.files[0]) {
                if (input.parentNode) document.body.removeChild(input);
                return;
            }
            
            const file = this.files[0];
            originalFile = file;
            
            // ========== NOW get location (after camera) ==========
            loading.style.display = 'flex';
            loadingText.textContent = 'üìç Getting your location...';
            loadingSubtext.textContent = 'Please wait...';
            
            let locationData = null;
            try {
                locationData = await getPreciseLocationPromise();
            } catch (locError) {
                console.error('Location error:', locError);
                // Continue without location
            }
            
            // ========== Process photo ==========
            loadingText.textContent = 'üì∏ Processing photo...';
            loadingSubtext.textContent = 'Almost done...';
            
            // Check if photo is from gallery
            const fileTime = file.lastModified;
            const currentTime = Date.now();
            const timeDiff = currentTime - fileTime;
            
            if (timeDiff > 120000) {
                loading.style.display = 'none';
                const usePhoto = confirm(
                    '‚ö†Ô∏è This photo appears to be from your gallery.\n\n' +
                    'For accurate tracking, please capture a NEW photo.\n\n' +
                    'Click OK to use this photo anyway, or Cancel to take a new one.'
                );
                if (!usePhoto) {
                    if (input.parentNode) document.body.removeChild(input);
                    return;
                }
                loading.style.display = 'flex';
            }
            
            // Read the file
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                capturedPhoto = e.target.result;
                photoTimestamp = new Date().toLocaleString('en-IN');
                
                const photoPreview = document.getElementById('photoPreview');
                photoPreview.src = capturedPhoto;
                photoPreview.style.display = 'block';
                document.getElementById('photoSection').style.display = 'block';
                
                // Try to extract EXIF GPS (skip on iOS)
                let exifGPS = null;
                if (!device.isIOS) {
                    exifGPS = await extractGPSFromImage(file);
                }
                
                // Priority: Device GPS > EXIF GPS
                if (locationData) {
                    displayGPSInfo(locationData, 'device');
                } else if (exifGPS) {
                    displayGPSInfo(exifGPS, 'exif');
                } else {
                    displayGPSInfo(null, null);
                }
                
                loading.style.display = 'none';
                
                const successMsg = locationData 
                    ? 'üì∏ Photo + GPS captured!' 
                    : 'üì∏ Photo captured (no GPS)';
                showToast(successMsg, 'success', 3000);
                
                // Enable Submit button after photo capture
                document.getElementById('submitBtn').disabled = false;
                
                // Cleanup
                if (input.parentNode) document.body.removeChild(input);
            };
            
            reader.onerror = function() {
                loading.style.display = 'none';
                showToast('‚ùå Error reading image file', 'error');
                if (input.parentNode) document.body.removeChild(input);
            };
            
            reader.readAsDataURL(file);
        };
        
        // ========== MUST be synchronous - no await before this! ==========
        input.click();
    }

    // =============================================
    // CAMERA CAPTURE BUTTON EVENT
    // =============================================
    document.getElementById('captureBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handleCameraCapture();
    });

    // =============================================
    // TIER SELECTION
    // =============================================
    document.querySelectorAll('input[name="tier"]').forEach(radio => {
    radio.addEventListener('change', function() {
        selectedTier = this.value;
        document.body.classList.remove('tier-platinum', 'tier-gold', 'tier-executive');
        document.querySelectorAll('.tier-btn').forEach(btn => btn.classList.remove('active'));
        document.body.classList.add(`tier-${this.value}`);
        this.closest('.tier-btn').classList.add('active');
        
        // Recalculate totals when tier changes (for platinum DSR bonus)
        calculateAll();
    });
});

    // =============================================
    // INPUT LISTENERS - Main Calculation
    // =============================================
    ['dsrCount', 'mnpCount', 'wifiCount', 'apbCount', 'simexCount', 'lapuTertiary', 'mnpDays', 'wifiDays'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', calculateAll);
    });

    // =============================================
    // INPUT LISTENERS - Device Share Calculation
    // =============================================
    ['airtelGross', 'jioMnp', 'jioDsr'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', calculateDeviceShare);
    });

    // =============================================
    // COLLECT FORM DATA
    // =============================================
    function collectFormData() {
        let latitude = '';
        let longitude = '';
        if (geoLocation) {
            const coords = geoLocation.split(',');
            if (coords.length === 2) {
                latitude = coords[0].trim();
                longitude = coords[1].trim();
            }
        }
        
        return {
            outletName: document.getElementById('outletName').value || '',
            lapuNo: document.getElementById('lapuNo').value || '',
            fseContact: document.getElementById('fseContact').value || '',
            tsmContact: document.getElementById('tsmContact').value || '',
            dsrCount: document.getElementById('dsrCount').value || '0',
            dsrAmount: document.getElementById('dsrAmount').value || '0',
            mnpCount: document.getElementById('mnpCount').value || '0',
            mnpAmount: document.getElementById('mnpAmount').value || '0',
            grossCount: document.getElementById('grossCount').value || '0',
            grossAmount: document.getElementById('grossAmount').value || '0',
            lapuTertiary: document.getElementById('lapuTertiary').value || '0',
            tertiaryAmount: document.getElementById('tertiaryAmount').value || '0',
            mnpDays: document.getElementById('mnpDays').value || '0',
            mnpDaysAmount: document.getElementById('mnpDaysAmount').value || '0',
            wifiDays: document.getElementById('wifiDays').value || '0',
            wifiDaysAmount: document.getElementById('wifiDaysAmount').value || '0',
            wifiCount: document.getElementById('wifiCount').value || '0',
            wifiAmount: document.getElementById('wifiAmount').value || '0',
            apbCount: document.getElementById('apbCount').value || '0',
            apbAmount: document.getElementById('apbAmount').value || '0',
            simexCount: document.getElementById('simexCount').value || '0',
            simexAmount: document.getElementById('simexAmount').value || '0',
            totalAmount: document.getElementById('totalAmount').textContent.replace('Total Amount Rs. ', ''),
            tier: selectedTier || '',
            dsrTarget: document.getElementById('dsrTarget').value || '0',
            mnpTarget: document.getElementById('mnpTarget').value || '0',
            totalTarget: document.getElementById('totalTarget').value || '0',
            wifiTarget: document.getElementById('wifiTarget').value || '0',
            viMnp: document.getElementById('viMnp').value || '0',
            viDsr: document.getElementById('viDsr').value || '0',
            jioMnp: document.getElementById('jioMnp').value || '0',
            jioDsr: document.getElementById('jioDsr').value || '0',
            airtelGross: document.getElementById('airtelGross').value || '0',
            deviceShare: document.getElementById('deviceShare').value || 'N/A',
            latitude: latitude,
            longitude: longitude,
            geoLocation: geoLocation || '',
            geoSource: geoSource || '',
            geoAccuracy: geoAccuracy || '',
            photoTimestamp: photoTimestamp || '',
            photoBase64: capturedPhoto || '',
            userAgent: navigator.userAgent,
            submissionTime: new Date().toISOString()
        };
    }

    // =============================================
    // SUBMIT TO GOOGLE SHEETS
    // =============================================
   document.getElementById('submitBtn').addEventListener('click', async function() {
    if (!capturedPhoto) {
        showToast('‚ö†Ô∏è Please capture a photo before submitting!', 'warning', 4000);
        return;
    }
    
    if (!geoLocation) {
        showToast('‚ö†Ô∏è Location not captured. Please try capturing photo again!', 'warning', 4000);
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const loadingSubtext = document.getElementById('loadingSubtext');
    
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Submitting...';
    loading.style.display = 'flex';
    loadingText.textContent = 'üì§ Submitting Data to Server...';
    
    try {
        const formData = collectFormData();
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(formData)
        });
        
        loading.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ Submitted!';
        showToast(`‚úÖ Enrollment submitted successfully!`, 'success', 6000);
        
        setTimeout(() => { submitBtn.textContent = 'Submit Data'; }, 3000);
    } catch (error) {
        loading.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Data';
        showToast('‚ùå Error submitting. Please try again.', 'error');
    }
});
    function autoCalcTotalTarget() {
        const dsr = parseInt(document.getElementById('dsrTarget').value) || 0;
        const mnp = parseInt(document.getElementById('mnpTarget').value) || 0;
        document.getElementById('totalTarget').value = dsr + mnp;
    }

    document.getElementById('dsrTarget').addEventListener('input', autoCalcTotalTarget);
    document.getElementById('mnpTarget').addEventListener('input', autoCalcTotalTarget);

    // =============================================
    // CLEAN PDF EXPORT & SHARE LOGIC (Merged)
    // =============================================
    document.getElementById('pdfBtn').addEventListener('click', async function () {
        
        // --- 1. VALIDATION FIRST ---
        // Tier validation
// --- 1. VALIDATION FIRST ---

// Tier validation
    if (!selectedTier) {
        alert('Please select a Tier before generating PDF.');
        return;
    }

    // Run existing field validations visually
    const allInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
    allInputs.forEach(input => input.dispatchEvent(new Event('blur')));

    // üö´ STOP if any field is marked invalid
    const invalidField = document.querySelector('input.invalid');
    if (invalidField) {
        alert('Please correct the highlighted fields before generating PDF.');
        invalidField.focus();
        return;
    }

    // üî¢ Strict 10-digit validation for specific fields
    const lapuNo = document.getElementById('lapuNo');
    const fseContact = document.getElementById('fseContact');
    const tsmContact = document.getElementById('tsmContact');

    const phoneRegex = /^\d{10}$/;

    if (!phoneRegex.test(lapuNo.value.trim())) {
        alert('Lapu No must be exactly 10 digits.');
        lapuNo.classList.add('invalid');
        lapuNo.focus();
        return;
    }

    if (!phoneRegex.test(fseContact.value.trim())) {
        alert('FSE Contact must be exactly 10 digits.');
        fseContact.classList.add('invalid');
        fseContact.focus();
        return;
    }

    if (!phoneRegex.test(tsmContact.value.trim())) {
        alert('TSM/SE Contact must be exactly 10 digits.');
        tsmContact.classList.add('invalid');
        tsmContact.focus();
        return;
    }
    // Validate ALL number fields
    const numberFields = document.querySelectorAll('input[type="number"]:not([readonly])');
    for (const field of numberFields) {
        if (field.value === '' || isNaN(field.value)) {
            alert('Please fill all numeric fields before generating PDF.');
            field.focus();
            return; // Stops here if invalid
        }
    }

        
        // --- 2. GENERATE PDF ---
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 12;
        const contentWidth = pageWidth - (margin * 2);
        
        // --- PDF STYLING & GENERATION FUNCTIONS ---
        const tierPalettes = {
            platinum: {
                primary: [180, 130, 130], secondary: [155, 110, 110], accent: [220, 87, 87],
                headerBg: [90, 60, 60], text: [255, 255, 255], darkText: [90, 32, 32],
                borderColor: [180, 130, 130], badge: [180, 130, 130]
            },
            gold: {
                primary: [200, 150, 100], secondary: [180, 130, 80], accent: [212, 165, 116],
                headerBg: [120, 85, 50], text: [255, 248, 220], darkText: [100, 70, 40],
                borderColor: [200, 150, 100], badge: [200, 150, 100]
            },
            executive: {
                primary: [225, 90, 90], secondary: [210, 75, 75], accent: [235, 100, 100],
                headerBg: [120, 50, 50], text: [255, 245, 245], darkText: [100, 40, 40],
                borderColor: [225, 90, 90], badge: [225, 90, 90]
            },
            default: {
                primary: [220, 87, 87], secondary: [200, 70, 70], accent: [235, 100, 100],
                headerBg: [90, 32, 32], text: [255, 255, 255], darkText: [90, 32, 32],
                borderColor: [220, 87, 87], badge: [220, 87, 87]
            }
        };

        function getPalette() {
            if (selectedTier === 'platinum') return tierPalettes.platinum;
            if (selectedTier === 'gold') return tierPalettes.gold;
            if (selectedTier === 'executive') return tierPalettes.executive;
            return tierPalettes.default;
        }

        function getSignatureOwner() {
            if (selectedTier === 'platinum') return 'ZBM';
            if (selectedTier === 'gold') return 'ZSM';
            if (selectedTier === 'executive') return 'TSM';
            return 'FSE';
        }

        const palette = getPalette();
        let yPos = margin;

        // -- Helpers --
        function addLuxuryHeader(title, subtitle, y) {
            pdf.setFillColor(...palette.headerBg);
            pdf.rect(0, 0, pageWidth, 22, 'F');
            pdf.setFillColor(...palette.accent);
            pdf.rect(0, 22, pageWidth, 1.5, 'F');
            pdf.setTextColor(...palette.text);
            pdf.setFontSize(15);
            pdf.setFont('helvetica', 'bold');
            pdf.text(title, pageWidth / 2, 10, { align: 'center' });
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(subtitle, pageWidth / 2, 17, { align: 'center' });
            if (selectedTier) {
                const badgeText = selectedTier.toUpperCase();
                const badgeWidth = 28;
                pdf.setFillColor(...palette.badge);
                pdf.roundedRect(pageWidth - margin - badgeWidth, 5, badgeWidth, 8, 2, 2, 'F');
                pdf.setTextColor(...palette.text);
                pdf.setFontSize(7);
                pdf.setFont('helvetica', 'bold');
                pdf.text(badgeText, pageWidth - margin - badgeWidth / 2, 10.5, { align: 'center' });
            }
            return 28;
        }
        
        function addSectionTitle(text, y) {
            const sectionHeight = 7;
            pdf.setFillColor(...palette.primary);
            pdf.rect(margin, y, contentWidth, sectionHeight, 'F');
            pdf.setFillColor(...palette.accent);
            pdf.rect(margin, y, 3, sectionHeight, 'F');
            pdf.setTextColor(...palette.text);
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'bold');
            pdf.text(text, margin + 7, y + 5);
            return y + sectionHeight + 1;
        }
        
        function addTableRow(label, value, y) {
            const rowHeight = 7;
            const labelWidth = contentWidth * 0.55;
            pdf.setFillColor(255, 255, 255);
            pdf.rect(margin, y, contentWidth, rowHeight, 'F');
            pdf.setDrawColor(...palette.borderColor);
            pdf.setLineWidth(0.2);
            pdf.rect(margin, y, contentWidth, rowHeight, 'S');
            pdf.line(margin + labelWidth, y, margin + labelWidth, y + rowHeight);
            pdf.setTextColor(...palette.darkText);
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'normal');
            pdf.text(String(label), margin + 3, y + 4.8);
            pdf.setFont('helvetica', 'bold');
            pdf.text(String(value), margin + labelWidth + 3, y + 4.8);
            return y + rowHeight;
        }
        
        function addThreeColumnRow(col1, col2, col3, y, isHeader = false) {
            const rowHeight = 7;
            const colWidth = contentWidth / 3;
            if (isHeader) {
                pdf.setFillColor(...palette.secondary);
                pdf.setTextColor(...palette.text);
            } else {
                pdf.setFillColor(255, 255, 255);
                pdf.setTextColor(...palette.darkText);
            }
            pdf.rect(margin, y, contentWidth, rowHeight, 'F');
            pdf.setDrawColor(...palette.borderColor);
            pdf.setLineWidth(0.2);
            pdf.rect(margin, y, contentWidth, rowHeight, 'S');
            pdf.line(margin + colWidth, y, margin + colWidth, y + rowHeight);
            pdf.line(margin + colWidth * 2, y, margin + colWidth * 2, y + rowHeight);
            pdf.setFontSize(8);
            pdf.setFont('helvetica', isHeader ? 'bold' : 'normal');
            pdf.text(String(col1), margin + colWidth * 0.5, y + 4.8, { align: 'center' });
            pdf.text(String(col2), margin + colWidth * 1.5, y + 4.8, { align: 'center' });
            pdf.text(String(col3), margin + colWidth * 2.5, y + 4.8, { align: 'center' });
            return y + rowHeight;
        }
        
        function addFourColumnRow(col1, col2, col3, col4, y, isHeader = false) {
            const rowHeight = 7;
            const colWidth = contentWidth / 4;
            if (isHeader) {
                pdf.setFillColor(...palette.secondary);
                pdf.setTextColor(...palette.text);
            } else {
                pdf.setFillColor(255, 255, 255);
                pdf.setTextColor(...palette.darkText);
            }
            pdf.rect(margin, y, contentWidth, rowHeight, 'F');
            pdf.setDrawColor(...palette.borderColor);
            pdf.setLineWidth(0.2);
            pdf.rect(margin, y, contentWidth, rowHeight, 'S');
            for (let i = 1; i < 4; i++) {
                pdf.line(margin + colWidth * i, y, margin + colWidth * i, y + rowHeight);
            }
            pdf.setFontSize(7);
            pdf.setFont('helvetica', isHeader ? 'bold' : 'normal');
            pdf.text(String(col1), margin + colWidth * 0.5, y + 4.8, { align: 'center' });
            pdf.text(String(col2), margin + colWidth * 1.5, y + 4.8, { align: 'center' });
            pdf.text(String(col3), margin + colWidth * 2.5, y + 4.8, { align: 'center' });
            pdf.text(String(col4), margin + colWidth * 3.5, y + 4.8, { align: 'center' });
            return y + rowHeight;
        }
        
        function addTotalBox(text, y) {
            const boxHeight = 12;
            pdf.setFillColor(...palette.primary);
            pdf.roundedRect(margin, y, contentWidth, boxHeight, 2, 2, 'F');
            pdf.setTextColor(...palette.text);
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.text(text.toUpperCase(), pageWidth / 2, y + 7.5, { align: 'center' });
            return y + boxHeight + 3;
        }
        
        function addGrossCommitmentRow(label, count, amount, y) {
            const rowHeight = 8;
            const colWidth = contentWidth / 3;
            pdf.setFillColor(255, 255, 255);
            pdf.rect(margin, y, contentWidth, rowHeight, 'F');
            pdf.setDrawColor(...palette.borderColor);
            pdf.setLineWidth(0.2);
            pdf.rect(margin, y, contentWidth, rowHeight, 'S');
            pdf.line(margin + colWidth, y, margin + colWidth, y + rowHeight);
            pdf.line(margin + colWidth * 2, y, margin + colWidth * 2, y + rowHeight);
            pdf.setTextColor(...palette.darkText);
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'bold');
            pdf.text(String(label), margin + colWidth * 0.5, y + 5.5, { align: 'center' });
            pdf.text(String(count), margin + colWidth * 1.5, y + 5.5, { align: 'center' });
            pdf.text('Rs. ' + String(amount), margin + colWidth * 2.5, y + 5.5, { align: 'center' });
            return y + rowHeight + 2;
        }
        
        function addSlabTable(y) {
            const slabData = [
                { target: '10', incentive: 'Rs.75/MNP', min: 10 },
                { target: '20', incentive: 'Rs.125/MNP', min: 20 },
                { target: '30', incentive: 'Rs.150/MNP', min: 30 },
                { target: '40+', incentive: 'Rs.200/MNP', min: 40 }
            ];
            const currentGross = parseInt(document.getElementById('grossCount').value) || 0;
            const slabColWidth = contentWidth / 2;
            const rowHeight = 6;
            
            pdf.setFillColor(...palette.secondary);
            pdf.rect(margin, y, contentWidth, rowHeight, 'F');
            pdf.setDrawColor(...palette.borderColor);
            pdf.setLineWidth(0.2);
            pdf.rect(margin, y, contentWidth, rowHeight, 'S');
            pdf.line(margin + slabColWidth, y, margin + slabColWidth, y + rowHeight);
            pdf.setTextColor(...palette.text);
            pdf.setFontSize(7);
            pdf.setFont('helvetica', 'bold');
            pdf.text('GROSS TARGET', margin + slabColWidth * 0.5, y + 4.2, { align: 'center' });
            pdf.text('INCENTIVE (PER MNP)', margin + slabColWidth * 1.5, y + 4.2, { align: 'center' });
            y += rowHeight;
            
            slabData.forEach((slab, index) => {
                let isActive = false;
                if (slab.target === '50+' && currentGross >= 50) {
                    isActive = true;
                } else if (slab.target !== '50+') {
                    const slabMin = slab.min;
                    const nextSlabMin = slabData[index + 1] ? slabData[index + 1].min : 999;
                    if (currentGross >= slabMin && currentGross < nextSlabMin) {
                        isActive = true;
                    }
                }
                pdf.setFillColor(255, 255, 255);
                pdf.setTextColor(...palette.darkText);
                pdf.rect(margin, y, contentWidth, rowHeight, 'F');
                pdf.setDrawColor(...palette.borderColor);
                pdf.rect(margin, y, contentWidth, rowHeight, 'S');
                pdf.line(margin + slabColWidth, y, margin + slabColWidth, y + rowHeight);
                pdf.setFontSize(7);
                pdf.setFont('helvetica', isActive ? 'bold' : 'normal');
                const activeIndicator = isActive ? ' (Current)' : '';
                pdf.text(slab.target, margin + slabColWidth * 0.5, y + 4.2, { align: 'center' });
                pdf.text(slab.incentive + activeIndicator, margin + slabColWidth * 1.5, y + 4.2, { align: 'center' });
                y += rowHeight;
            });
            return y + 2;
        }
        
        function addPageFooter(pageNum, totalPages) {
            pdf.setDrawColor(...palette.borderColor);
            pdf.setLineWidth(0.3);
            pdf.line(margin, pageHeight - 12, pageWidth - margin, pageHeight - 12);
            pdf.setFontSize(7);
            pdf.setTextColor(130, 130, 130);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Page ' + pageNum + ' of ' + totalPages, margin, pageHeight - 7);
            pdf.text('Generated: ' + new Date().toLocaleString('en-IN'), pageWidth / 2, pageHeight - 7, { align: 'center' });
            const docId = 'ENR-' + Date.now().toString(36).toUpperCase();
            pdf.text(docId, pageWidth - margin, pageHeight - 7, { align: 'right' });
        }
        
        // --- PAGE 1 CONTENT ---
        yPos = addLuxuryHeader('RETAILER ENROLLMENT SHEET', 'February 2025', yPos);
        yPos = addSectionTitle('RETAILER INFORMATION', yPos);
        yPos = addTableRow('Outlet Name', document.getElementById('outletName').value || '-', yPos);
        yPos = addTableRow('Lapu No', document.getElementById('lapuNo').value || '-', yPos);
        yPos = addTableRow('FSE Contact No', document.getElementById('fseContact').value || '-', yPos);
        yPos = addTableRow('TSM/SE Contact No', document.getElementById('tsmContact').value || '-', yPos);
        yPos += 3;
        
        yPos = addSectionTitle('MARGIN CALCULATIONS', yPos);
        yPos = addThreeColumnRow('Item', 'Value', 'Amount (Rs.)', yPos, true);
        yPos = addThreeColumnRow('Lapu Tertiary (3%)', document.getElementById('lapuTertiary').value || '0', document.getElementById('tertiaryAmount').value || '0', yPos);
        yPos = addThreeColumnRow('MNP Days (1.4%)', document.getElementById('mnpDays').value || '0', document.getElementById('mnpDaysAmount').value || '0', yPos);
        yPos = addThreeColumnRow('WiFi Days (1.5%)', document.getElementById('wifiDays').value || '0', document.getElementById('wifiDaysAmount').value || '0', yPos);
        yPos += 3;
        
        yPos = addSectionTitle('ADDITIONAL ITEMS', yPos);
        yPos = addThreeColumnRow('Item', 'Count', 'Amount (Rs.)', yPos, true);
        yPos = addThreeColumnRow('WIFI (Rs.150)', document.getElementById('wifiCount').value || '0', document.getElementById('wifiAmount').value || '0', yPos);
        yPos = addThreeColumnRow('APB SBA (Rs.45)', document.getElementById('apbCount').value || '0', document.getElementById('apbAmount').value || '0', yPos);
        yPos = addThreeColumnRow('SIMEX (Rs.50)', document.getElementById('simexCount').value || '0', document.getElementById('simexAmount').value || '0', yPos);
        yPos += 3;


        yPos = addSectionTitle('OTF CALCULATIONS', yPos);
        yPos = addThreeColumnRow('Item', 'Count', 'Amount (Rs.)', yPos, true);
        yPos = addThreeColumnRow('DSR OTF (Rs.135)', document.getElementById('dsrCount').value || '0', document.getElementById('dsrAmount').value || '0', yPos);
        yPos = addThreeColumnRow('MNP OTF (Rs.235)', document.getElementById('mnpCount').value || '0', document.getElementById('mnpAmount').value || '0', yPos);
        yPos = addGrossCommitmentRow('GROSS COMMITMENT(DTR-Slab Incentive)', document.getElementById('grossCount').value || '0', document.getElementById('grossAmount').value || '0', yPos);
        
        
        
        yPos = addTotalBox(document.getElementById('totalAmount').textContent || 'Total Amount Rs. 0', yPos);
        addPageFooter(1, 2);
        
        // --- PAGE 2 CONTENT ---
        pdf.addPage();
        yPos = margin;
        pdf.setFillColor(...palette.headerBg);
        pdf.rect(0, 0, pageWidth, 14, 'F');
        pdf.setFillColor(...palette.accent);
        pdf.rect(0, 14, pageWidth, 1, 'F');
        pdf.setTextColor(...palette.text);
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'bold');
        pdf.text('VERIFICATION & AUTHORIZATION', pageWidth / 2, 9, { align: 'center' });
        yPos = 20;
        
        yPos = addSectionTitle('DECLARATION', yPos);
        pdf.setFillColor(255, 255, 255);
        pdf.setDrawColor(...palette.borderColor);
        pdf.rect(margin, yPos, contentWidth, 14, 'FD');
        pdf.setTextColor(...palette.darkText);
        pdf.setFontSize(7);
        pdf.setFont('helvetica', 'normal');
        const declaration = 'I hereby confirm that all information provided above is accurate and complete. I agree to comply with the terms and conditions of the retailer enrollment program for the February 2025 period.';
        const splitDeclaration = pdf.splitTextToSize(declaration, contentWidth - 8);
        pdf.text(splitDeclaration, margin + 4, yPos + 5);
        yPos += 17;
        
        yPos = addSectionTitle('SIGNATURES', yPos);
        const sigBoxWidth = (contentWidth - 6) / 2;
        const sigBoxHeight = 32;
        pdf.setFillColor(255, 255, 255);
        pdf.setDrawColor(...palette.borderColor);
        pdf.rect(margin, yPos, sigBoxWidth, sigBoxHeight, 'FD');
        pdf.setTextColor(...palette.darkText);
        pdf.setFontSize(7);
        pdf.setFont('helvetica', 'bold');
        pdf.text('RETAILER SIGNATURE', margin + 4, yPos + 5);
        const owner = getSignatureOwner();
        const ownerX = margin + sigBoxWidth + 6;
        pdf.setFillColor(255, 255, 255);
        pdf.rect(ownerX, yPos, sigBoxWidth, sigBoxHeight, 'FD');
        pdf.text(owner + ' SIGNATURE', ownerX + 4, yPos + 5);
        yPos += sigBoxHeight + 8;
        if (selectedTier) {
            pdf.setTextColor(...palette.darkText);
            pdf.setFontSize(6);
            pdf.setFont('helvetica', 'bold');
            pdf.text(selectedTier.toUpperCase() + ' TIER ENROLLMENT', pageWidth - margin, yPos + 1, { align: 'right' });
        }
        
        // --- 3. OUTPUT & SHARE ---
        const outlet = document.getElementById('outletName').value || 'Retailer';
        const tierSuffix = selectedTier ? '_' + selectedTier.toUpperCase() : '';
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `Enrollment_${outlet.replace(/[^a-zA-Z0-9]/g, '_')}${tierSuffix}_${dateStr}.pdf`;

        const pdfBlob = pdf.output('blob');
        
        // Helper to trigger download
        const triggerDownload = (blob, name) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a); // Required for some browsers
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        };

        // Enable Capture Photo button since PDF is generated
        document.getElementById('captureBtn').disabled = false;

        // Try Web Share API with Fallback
        const file = new File([pdfBlob], filename, { type: 'application/pdf' });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Retailer Enrollment',
                    text: 'Please find the enrollment PDF attached.'
                });
            } catch (err) {
                // Share cancelled or failed, fallback to download
                triggerDownload(pdfBlob, filename);
            }
        } else {
            // Share not supported, fallback to download
            triggerDownload(pdfBlob, filename);
        }
    });

    // =============================================
    // INITIALIZE
    // =============================================
    window.addEventListener('DOMContentLoaded', async () => {
        initializeValidations();
        calculateAll();
        calculateDeviceShare();
        const device = getDeviceInfo();
        displayGPSInfo(null, null);
    });

    // =============================================
    // SWIFT APP INTEGRATION (iOS App Support)
    // =============================================
    ;(function() {
        window.injectedLocation = null;
        window.swiftGPSReady = function(lat, lon, acc) {
            geoLocation = `${parseFloat(lat).toFixed(6)}, ${parseFloat(lon).toFixed(6)}`;
            geoSource = 'Swift Real GPS';
            geoAccuracy = `${Math.round(acc)}m`;
            const geoInfo = document.getElementById('geoInfo');
            geoInfo.innerHTML = `
                <strong>Real GPS Locked (via App)</strong><br>
                <span class="geo-badge device" style="background:#28a745;color:white;padding:4px 8px;border-radius:4px;font-size:11px;">SWIFT GPS ‚úì</span><br><br>
                <strong>Coordinates:</strong> ${geoLocation}<br>
                <strong>Accuracy:</strong> ¬±${geoAccuracy}<br>
                <small>100% accurate ‚Ä¢ Works on HTTP ‚Ä¢ Used by Airtel/Jio FSEs</small>
            `;
            geoInfo.classList.remove('no-source','ip-source');
            geoInfo.classList.add('device-source');
            geoInfo.style.display = 'block';
            document.getElementById('photoSection').style.display = 'block';
            showToast('Real GPS captured successfully!', 'success', 4000);
        };
        const check = setInterval(() => {
            if (window.injectedLocation) {
                clearInterval(check);
                window.swiftGPSReady(
                    window.injectedLocation.latitude,
                    window.injectedLocation.longitude,
                    window.injectedLocation.accuracy
                );
            }
        }, 700);
        if (/iPhone|iPad|iPod/.test(navigator.userAgent) && !navigator.userAgent.includes('SwiftApp')) {
            setTimeout(() => {
                if (!window.injectedLocation && !geoLocation) {
                    showToast('üìç Tap "Capture Photo" to get GPS + Photo', 'info', 5000);
                }
            }, 4000);
        }
    })();
</script>
</body>

</html>




